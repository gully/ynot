%\documentclass[twocolumn]{emulateapj}% change onecolumn to iop for fancy, iop to onecolumn for manuscript
\documentclass[twocolumn]{aastex63}
\bibliographystyle{aasjournal}

\usepackage{graphicx}
\usepackage[caption=false]{subfig}
\usepackage{amsmath}
\usepackage{lipsum}
\usepackage[]{mdframed}
\usepackage{booktabs}

\usepackage{fontspec}
\usepackage[T1]{fontenc}
\usepackage{newtxsf}
%\setmainfont{Fira Sans Book}[Scale=1.05]


\let\pwiflocal=\iffalse \let\pwifjournal=\iffalse



\shorttitle{Autodiff for 2D echellograms}
\shortauthors{Gully-Santiago}
%\bibliographystyle{yahapj}

\begin{document}
\title{Towards a Spectrograph Digital Twin: Forward Modeling Pixels of 2D Echellograms with Interpretable Machine Learning}

\author{Michael Gully-Santiago}
\affiliation{University of Texas at Austin Department of Astronomy}

\author{TBD}
\affiliation{TBD}


\begin{abstract}

  We introduce autodiff for 2D echellogram forward modeling.

\end{abstract}

\keywords{data: data analysis ---  stars: statistics}


\section{Introduction}\label{sec:intro}

Virtually all modern insights derived from observational optical spectroscopy first arrive through the lossy, imperfect, and unavoidable process of digitization onto a 2-dimensional focal plane array detector.  Moore's law has propelled the amount of spectrosopic information we can cram onto these detectors over the last 50 years, with the number of pixels catapulting up to a billion-fold.  Innovative optical designs have made evermore effective use of these pixels with information-rich multi-object, imager slicer, and \`echellogram spectral formats.  The computerized distillation of the target spectrum is generally turnkey.  Facility reduction pipelines provide the humdrum translation of raw 2D pixels to familiar 1D extracted spectra, ideally an afterhought in a practioner's journey from observation to scientific results.

But increasingly our greatest scientific ambitions are pushing against the limits of how much information we can squeeze out of a given spectrographic observation.  The discovery of other Earths, the redshift of the epoch of reionization, and some of the most important unrealized astronomical discoveries in a generation will occur in the margins of what our most powerful spectrographs can deliver.

The measurement of Extreme Precision Radial Velocity (EPRV) stands out as particularly susceptible to the vagueries of the spectral extraction process.  The instrumental Radial Velocity (RV) precision needed to detect an Earth-like planet around a Sun-like star amounts to a mere 1 cm/s, equivalent to a distance of 10 silicon atoms in a typical spectrograph pixel (cite HPF).  Sub-pixel flat fields (cite XX), charge transfer inefficiencies (cite XX), and other seemingly pathological materials science phenomena matter at these precisions.  Spectral extraction is \emph{not} turnkey at the level of 10 Si atoms.  These precision demands have catalyzed a renewed interest in understanding the delicate interplay of the incident stellar spectrum with the detector pixels.

Most 2D \'echellogram data reduction pipelines can be described as data-driven extraction procedures as opposed to interpretable scene models. The most auspicious of these procedures may be ``Optimal Extraction'' \citep{1986PASP...98..609H}, which treats each column as an independent example of a 1D line profile, enabling a Gaussian weighting in the cross-dispersion direction.  This prescription faithfully incorporates low-but-significant Signal-to-Noise Ratio (SNR) pixels.  Translating Optimal Extraction to \'echelle spectra gets complicated by the dense and sometime overlapping layouts of the so-called \'echellogram format.  Spectral traces generally do not align with the pixel coordinates, often curving into smile-shaped arcs.  Specialized methods have been developed to handle these layouts \citep{2002A&A...385.1095P,2020arXiv200805827P}.

The desire to reach the photon-noise limit motivated a subtle mental leap compared to Optimal Extraction.  ``Spectro-perfectionism'' \citep{2010PASP..122..248B} represents a \emph{scene model}, allowing arbitrary 2D PSF shapes with unknown morphologies, convolved with an underlying super-resolution 1D spectrum with unknown spectral structure.  This arbitrary 2D PSF better resembles the aberrations of a genuine optical system, albeit at high computational cost with the inevitability of introducing artificial ringing artifacts into the deconvolved spectrum\footnote{\url{https://hoggresearch.blogspot.com/2019/10/complexifying-optimal-extraction.html}}.  Flat-relative optimal extraction \citep{2014A&A...561A..59Z} avoided the need to model the actual PSF by introducing a data-driven scheme for weighting the pixels.

These existing techniques generally suit the vast majority of use cases, but necessarily cannot handle all science applications.  For example, spatially resolved binaries with separations less than the spectrograph slit length can be acquired with alignment along a spectrograph entrance slit, nominally offering two spectra for the price of one.  But data acquired in this way would break most normal pipelines.  More generally, any extended source, such as a photo-dissociation regions (PDR), Solar System surfaces, or circumstellar Keplerian gas disks, possess an admixture of spatial and spectral information convolved together in a way that can make separation and interpretation difficult.  Some solutions, such as spectroastrometry (cite XX) can help, but a general purpose scene-modeling tool for optical spectroscopy appears lacking.

Brown dwarfs stand out as a particularly adversarial example for spectral extraction for two reasons.  Their intrinsically low luminosities mean that all but the closest brown dwarfs have low signal-to-noise ratio at high spectral resolution with existing facilities.  Moreover, their ultracool atmospheres contain many molecular absorption bands, in which large swaths of spectra plunge to near zero flux.  The combination of low signal-to-noise ratio and large chunks of missing continuum means that the mere act of identifying a spectral trace becomes difficult. Emission line sources lack a continuum entirely, defying the common pipeline assumption of some detectable spectrum in each pixel sequence.  Heuristics for handling these special cases may exist, but they are often afterthoughts or require user intervention to guide the process along.

In EPRV, the assumptions in optimal extraction are not actually optimal.  These approaches generally treat the cross-dispersion direction as exactly aligned with the detector $y$ axis, a computationally expedient heuristic. The RV bias of optimal extraction grows as the spectral traces tilt and bend farther from the detector pixel alignment.  Straight-but-tilted traces have the effect of polluting adjacent wavelength bins in nearly equal measure and, to first order, lowering the effective spectral resolving power.  Curved \'echelle traces are more insidious.  Here, the smearing of pixels can be expected to proceed with a systematic RV shift, since the shoulder of one spectral line notices more of its pixel neighbor to the left or right, depending on the extent and direction of the spectral trace's curvature.  These seemingly pathological minor biases must make a difference at the 10 Si atom level, but quantifying such complex effects has been elusive in part due to the lack of an end-to-end simulation framework for \'echellograms.

In this work we put forth a framework for a spectrograph \'echellogram \emph{digital twin}.  This term refers to a class of extreme forward modeling--a digital twin should represent all or most of the relevant behaviors of a complex system in a way that can be interrogated to build novel insights.  A digital twin should resemble---as close as possible---the actual state of the system at any given moment, providing simulated data that is indistinguishable from a genuine observation.  An \'echelle spectrograph digital twin therefore builds upon but transcends the notions of scene modeling introduced in \citet{2010PASP..122..248B}, by aspiring to include evermore realistic attributes of the spectrograph's imaging system into the computational machinery.  A digital twin would improve upon these limitations by providing a more physically realistic generative model for the underlying spectrum.


\textbf{The challenge: instrumental defects and imperfections.}


\begin{mdframed}
  \textbf{Common assumptions embedded into current techniques} \par
  - Single point source\par
  - Source has continuum\par
  - Continuum is high SNR\par
  - Relatively few segments of uninterrupted continuum\par
  - Trends adequately captured by polynomials\par
  - Symmetric, Gaussian-like PSF\par
\end{mdframed}

\begin{mdframed}
  \textbf{Extreme or unusual spectra break these assumptions} \par
  - brown dwarfs with low SNR and highly structured/missing spectra\par
  - emission line spectra (no continuum)\par
  - binary stars on the same slit\par
  - extended objects (non-point sources)\par
  - EPRV\par
\end{mdframed}

\begin{mdframed}
  \textbf{Many heuristics designed to cope with departures from these assumptions} \par
  \textcolor{lightgray}{\lipsum[4]}
\end{mdframed}

\begin{mdframed}
  \textbf{Philosphy: Each previous spectrum should inform future spectra} \par
  Treat the instrument as a breathing, dynamic system\par
  \textcolor{lightgray}{\lipsum[5]}
\end{mdframed}

\begin{mdframed}
  \textbf{The epic hero: autodiff and GPUs, PyTorch, flexible models} \par
  - Why this is only recently possible\par
  - Why this may be in some ways easier to reason about than heuristics\par
  - This work: A new autodiff-aware 2D echellogram modeling framework\par
  \textcolor{lightgray}{\lipsum[6]}
\end{mdframed}


\section{Methodology: Modeling 2D Pixels}

\begin{mdframed}
  \textbf{A mapping of $(x, y)$ pixel coordinates to $(\lambda, s)$ physical coordinates} \par
  \textcolor{lightgray}{\lipsum[7]}
\end{mdframed}

\begin{mdframed}
  \textbf{How to represent the target spectrum} \par
  - How to represent the sky spectrum\par
  - How to represent the target PSF\par
  - How to represent the sky spatial extent\par
  - How to represent the slit\par
\end{mdframed}


\subsection{Constructing a Resilient Likelihood}
\begin{mdframed}
  \textbf{The need to joint model, regularize, address outliers} \par
  - The likelihood function and per-pixel uncertainties\par
  - Arcs: sparsely encode both wavelength and slit position\par
  - Flats: encode just slit position\par
  - Darks: encode just background\par
  - Target spectra: encode wavelength, slit position, target position\par
  \textcolor{lightgray}{\lipsum[7]}
\end{mdframed}


\section{Results 1: Training on Synthetic Data with Injection/Recovery Tests}

\begin{mdframed}
  \textbf{Injection/recovery test with noisy data: generating fake data} \par
  \textcolor{lightgray}{\lipsum[9]}
\end{mdframed}

\begin{mdframed}
  \textbf{Initializing of the model and optimization setup} \par
  \textcolor{lightgray}{\lipsum[10]}
\end{mdframed}


\begin{mdframed}
  \textbf{Training computational performance} \par
  - Number of epochs\par
  - Batching/sparsity\par
  \textcolor{lightgray}{\lipsum[9]}
\end{mdframed}

\begin{mdframed}
  \textbf{Best fit model comparison 1: injection/recovery of initial parameters} \par
  - Number of epochs\par
  - Batching/sparsity\par
  \textcolor{lightgray}{\lipsum[10]}
\end{mdframed}

\begin{mdframed}
  \textbf{Best fit model comparison 2: spectrum as unbinned, weighted samples} \par
  - Number of epochs\par
  - Batching/sparsity\par
  \textcolor{lightgray}{\lipsum[11]}
\end{mdframed}


\section{Results 2: Training on real data}
\begin{mdframed}
  \textbf{Introduction to real data} \par
  - Data-preprocessing and heuristics \par
  \textcolor{lightgray}{\lipsum[12]}
\end{mdframed}

\begin{mdframed}
  \textbf{Outcome: reduced spectrum as unbinned, weighted samples} \par
  - SNR improvement compared to previous methods (head-to-head)\par
  \textcolor{lightgray}{\lipsum[13]}
\end{mdframed}

\pagebreak
\clearpage

\section{Discussion}
\begin{mdframed}
  \textbf{The promise for EPRV} \par
  - Simulation of minor RV shifts\par
  - Simulation of sub-pixel flat fields \par
  - Tracking spectrograph state across decades of operation\par
  \textcolor{lightgray}{\lipsum[14]}
\end{mdframed}


\begin{mdframed}
  \textbf{Ability to repurpose non-standard data (variable data quality)} \par
  \textcolor{lightgray}{\lipsum[15]}
\end{mdframed}


\begin{mdframed}
  \textbf{Conceivable extensions} \par
  \textcolor{lightgray}{\lipsum[16]}
\end{mdframed}



\acknowledgements


\facilities{Keck (NIRSPEC), Gaia}

\software{  pandas \citep{mckinney10, reback2020pandas},
  matplotlib \citep{hunter07},
  numpy \citep{harris2020array},
  scipy \citep{jones01},
  ipython \citep{perez07},
  pytorch \citep{NEURIPS2019_9015}}

\appendix

\section{Comparison to other frameworks}

Hundreds or possibly thousands of 2D extraction pipelines have been written and rewritten to suit the disparate needs of each unique spectrograph.  Table 1 of \citet{2022PASP..134k4509C} lists 18 \'echelle spectrographs and their data reduction pipelines.  Many but not all of those pipelines are open source.  Here we list a subset of recent open source pipelines for \'echelle spectra reduction.

Few approaches have attempted to combine spectral scene modeling in combination with machine learning techniques.  \citet{2020MNRAS.499.1972X} employed a 2D PSF convolution with neural networks on a demonstration with multi-object spectra from LAMOST.  While promising, the code is not open source and the applications limited to inferring the field distortion, but not extending to subsequent extraction steps.


\begin{deluxetable*}{lllll}
  \tablewidth{0pc}
  \tablecaption{
    Open source codes for 2D echelle data reduction
    \label{tabHeSM}
  }
  \tablehead{
    \colhead{Code}   &
    \colhead{Instrument} &
    \colhead{Reference} &
    \colhead{Language} &
    \colhead{Note}
  }
  \startdata
  \hline
  \multicolumn{5}{c}{\'echelle} \\
  \hline
  \href{https://github.com/igrins/plp}{PLP} & IGRINS & \citet{2014AdSpR..53.1647S, jaejoonlee15} & Python & \\
  \href{https://github.com/AWehrhahn/PyReduce}{PyReduce} & HARPS, UVES & \citet{2021AA...646A..32P} & Python & \\
  \href{https://github.com/njcuk9999/apero-drs}{APERO} & SPIRou & \citep{2022PASP..134k4509C} & Python &\\
  \hline
  \multicolumn{5}{c}{Long-slit} \\
  \hline
  \href{https://github.com/LSSTDESC/Spectractor}{Spectractor} & CTIO & \citep{2023arXiv230704898N} & Python & Scene Modeling\\
  \enddata
  \tablecomments{Some codes are applicable to multiple instruments, and some instruments have multiple codes.}
\end{deluxetable*}




\clearpage

\bibliographystyle{apj}
\bibliography{ms}

\end{document}
